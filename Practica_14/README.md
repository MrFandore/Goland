# –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ14: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ connection pool

`–§–ò–û`: –ö–æ–∑–∏–Ω –ì–µ–æ—Ä–≥–∏–π –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á

`–ì—Ä—É–ø–ø–∞`: –ü–ò–ú–û-01-25

## –¶–µ–ª—å:
>üéØ –¶–µ–ª—å: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ connection pool
---

> üí° Important: –í —Ü–µ–ª—è—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞, –±—ã–ª–æ –ø—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç—å –æ–¥–∏–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –¥–∏—Ä–∏–∫—Ç–æ—Ä–∏—è–º–∏
> –¥–æ–º–∞—à–Ω–∏—Ö —Ä–∞–±–æ—Ç.
---

## –ó–∞–¥–∞–Ω–∏–µ:
1.	–ù–∞—É—á–∏—Ç—å—Å—è –Ω–∞—Ö–æ–¥–∏—Ç—å ¬´—É–∑–∫–∏–µ –º–µ—Å—Ç–∞¬ª –≤ SQL-–∑–∞–ø—Ä–æ—Å–∞—Ö –∏ —É—Å—Ç—Ä–∞–Ω—è—Ç—å –∏—Ö (–∏–Ω–¥–µ–∫—Å—ã, –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–∞–≥–∏–Ω–∞—Ü–∏—è, –±–∞—Ç—á–∏–Ω–≥).
2.	–û—Å–≤–æ–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—É–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (connection pool) –≤ Go –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –µ–≥–æ —Ç—é–Ω–∏–Ω–≥–∞.
3.	–ù–∞—É—á–∏—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å EXPLAIN/ANALYZE, –±–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (pg_stat_statements), –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
4.	–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫–∏ —É–º–µ–Ω—å—à–µ–Ω–∏—è N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∞–ª–ª–æ–∫–∞—Ü–∏–π –Ω–∞ –≥–æ—Ä—è—á–µ–º –ø—É—Ç–∏.


### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:
```
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ cmd
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ api
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ main.go
‚îú‚îÄ‚îÄ docker-compose.yaml
‚îú‚îÄ‚îÄ go.mod
‚îú‚îÄ‚îÄ go.sum
‚îî‚îÄ‚îÄ internal
    ‚îú‚îÄ‚îÄ config
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ config.go
    ‚îú‚îÄ‚îÄ model
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ note.go
    ‚îú‚îÄ‚îÄ pagination
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ cursor.go
    ‚îú‚îÄ‚îÄ storage
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ postgres
    ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ queries.go
    ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ repo.go
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ redis
    ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ cache.go
    ‚îî‚îÄ‚îÄ transport
        ‚îî‚îÄ‚îÄ http
            ‚îú‚îÄ‚îÄ handlers.go
            ‚îú‚îÄ‚îÄ respond.go
            ‚îî‚îÄ‚îÄ server.go
```

#### –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞:
1) –ö–ª–æ–Ω–∏–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
```bash
git clone https://github.com/CyberGeo335/pish_golang.git
```
2) –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Go –∏ Git –µ—Å—Ç—å:

```bash
pish_golang % cd Practica_14
Practica_14 % go version
go version go1.23.2 darwin/arm64
Practica_14 % git --version
git version 2.39.5 (Apple Git-154)
Practica_14 % 
```

3) –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–µ–≤—è—Ç—É—é —Ä–∞–±–æ—Ç—É:

```bash
cd Practica_14/cmd
```

4) –ü—Ä–∏–º–µ—Ä –Ω–∞—à–µ–≥–æ `.env`:
```bash
# Remote Postgres
DB_DSN=postgres://root:root@http://address:5432/pz9_bcrypt?sslmode=disable

# HTTP
HTTP_ADDR=:8087

# Redis (–ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ docker compose)
REDIS_ADDR=127.0.0.1:6379
REDIS_PASSWORD=kek
REDIS_DB=0
CACHE_TTL_SECONDS=45

```

5) –ó–∞–ø—É—Å–∫ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ:
```bash
go build -o bin/Practica_14 ./cmd/api/

nohup ./bin/Practica_14 >Practica_14.log 2>&1 &
```

6) –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å—ë —Ä–∞–≤–±–æ—Ç–∞–µ—Ç (–ø–∏–∫—á–∞ 3):
```bash
curl -s http://178.72.139.210:8087/health
```

![–°–∫—Ä–∏–Ω—à–æ—Ç](./assets/–°–Ω–∏–º–æ–∫%20—ç–∫—Ä–∞–Ω–∞%202025-12-12%20–≤%2012.13.13.png)
![–°–∫—Ä–∏–Ω—à–æ—Ç](./assets/–°–Ω–∏–º–æ–∫%20—ç–∫—Ä–∞–Ω–∞%202025-12-12%20–≤%2013.18.17.png)
![–°–∫—Ä–∏–Ω—à–æ—Ç](./assets/–°–Ω–∏–º–æ–∫%20—ç–∫—Ä–∞–Ω–∞%202025-12-12%20–≤%2013.26.25.png)



7) –°–æ–∑–¥–∞–¥–∏–º –∑–∞–º–µ—Ç–∫—É (–ø–∏–∫—á–∞ 4):
```bash
curl -s -X POST http://178.72.139.210:8087/notes \
  -H 'Content-Type: application/json' \
  -d '{"title":"redis tips","content":"..."}'
```

![–°–∫—Ä–∏–Ω—à–æ—Ç](./assets/–°–Ω–∏–º–æ–∫%20—ç–∫—Ä–∞–Ω–∞%202025-12-12%20–≤%2013.27.44.png)

8) –ü–æ–ª—É—á–∏—Ç—å –ø–æ Id, –≥–¥–µ –≤—Ç–æ—Ä–æ–π –¥–æ–ª–∂–µ–Ω –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å—Å—è  (–ø–∏–∫—á–∞ 5):
```bash
curl -s http://178.72.139.210:8087/notes/1
curl -s http://178.72.139.210:8087/notes/1
```

![–°–∫—Ä–∏–Ω—à–æ—Ç](./assets/–°–Ω–∏–º–æ–∫%20—ç–∫—Ä–∞–Ω–∞%202025-12-12%20–≤%2013.29.21.png)

9) –°–ø–∏—Å–æ–∫ (keyset) + –ø–æ–∏—Å–∫ –ø–æ title (FTS) (–ø–∏–∫—á–∞ 6):
```bash
curl -s "http://178.72.139.210:8087/notes?limit=20&q=redis"
curl -s "http://178.72.139.210:8087/notes?limit=20&q=redis&cursor="eyJjcmVhdGVkX2F0IjoiMjAyNS0xMi0xMlQxMDoyNzozNy43NjU3WiIsImlkIjoxfQ"
```

![–°–∫—Ä–∏–Ω—à–æ—Ç](./assets/–°–Ω–∏–º–æ–∫%20—ç–∫—Ä–∞–Ω–∞%202025-12-12%20–≤%2013.44.37.png)

10) –°–ø–∏—Å–æ–∫ (keyset) + –ø–æ–∏—Å–∫ –ø–æ title (FTS) (–ø–∏–∫—á–∞ 7):
```bash
curl -s -X PATCH http://178.72.139.210:8087/notes/1 \
  -H 'Content-Type: application/json' \
  -d '{"title":"redis tips v2","content":"updated"}'
```

![–°–∫—Ä–∏–Ω—à–æ—Ç](./assets/–°–Ω–∏–º–æ–∫%20—ç–∫—Ä–∞–Ω–∞%202025-12-12%20–≤%2013.45.02.png)

11) –ë–∞—Ç—á –≤–º–µ—Å—Ç–æ N+1 (–ø–∏–∫—á–∞ 8):
```bash
curl -s "http://178.72.139.210:8087/notes/batch?ids=1,2,3,4"
```

![–°–∫—Ä–∏–Ω—à–æ—Ç](./assets/–°–Ω–∏–º–æ–∫%20—ç–∫—Ä–∞–Ω–∞%202025-12-12%20–≤%2013.46.32.png)


### –ü–æ—è—Å–Ω—è–ª–∫–∏:
#### 2
–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±—ã–ª–æ —Ç—Ä–∏ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞:
* –ü–µ—Ä–≤–∞—è ‚Äî –ø–∞–≥–∏–Ω–∞—Ü–∏—è —á–µ—Ä–µ–∑ OFFSET: —á–µ–º –¥–∞–ª—å—à–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞, —Ç–µ–º –±–æ–ª—å—à–µ —Å—Ç—Ä–æ–∫ –±–∞–∑–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏, –ø–æ—ç—Ç–æ–º—É –≤—Ä–µ–º—è
—Ä–∞—Å—Ç—ë—Ç –ø–æ—á—Ç–∏ –ª–∏–Ω–µ–π–Ω–æ —Å –Ω–æ–º–µ—Ä–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã. 
* –í—Ç–æ—Ä–∞—è ‚Äî N+1: —Å–∞–º–∏ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –ø–µ—Ä–≤–∏—á–Ω–æ–º—É –∫–ª—é—á—É –≤—ã–≥–ª—è–¥—è—Ç –±—ã—Å—Ç—Ä—ã–º–∏, –Ω–æ –∫–æ–≥–¥–∞ –∏—Ö N —à—Ç—É–∫, —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–µ—Ç–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ 
round-trip‚Äô–æ–≤ –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç –∏ p95/p99 —Ä–µ–∑–∫–æ —Ä–∞—Å—Ç—É—Ç. 
* –¢—Ä–µ—Ç—å—è ‚Äî –ø–æ–∏—Å–∫ –ø–æ title: –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞–ø–∏—Å–∞–Ω –Ω–µ –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–¥ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞, Postgres –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GIN 
–∏ —É—Ö–æ–¥–∏—Ç –≤ Seq Scan, —á—Ç–æ –≤ EXPLAIN –≤–∏–¥–Ω–æ —Å—Ä–∞–∑—É: Seq Scan + Filter –∏ –º–Ω–æ–≥–æ BUFFERS read.
#### 3
–ü—Ä–∏–º–µ–Ω–∏–ª–∏ –¥–≤–∞ –≤–∏–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π: 
* –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∏–Ω–¥–µ–∫—Å—ã. –ó–∞–ø—Ä–æ—Å—ã: OFFSET –∑–∞–º–µ–Ω–∏–ª–∏ –Ω–∞ keyset-–ø–∞–≥–∏–Ω–∞—Ü–∏—é –ø–æ –ø–∞—Ä–µ (created_at, id), —á—Ç–æ–±—ã –±–∞–∑–∞ 
–ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ —á—Ç–µ–Ω–∏–µ ‚Äú—Å –º–µ—Å—Ç–∞‚Äù, –∞ –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–ª–∞ –≤—Å—é –≥–ª—É–±–∏–Ω—É OFFSET. N+1 –∑–∞–º–µ–Ω–∏–ª–∏ –Ω–∞ –æ–¥–∏–Ω –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å –ø–æ –º–∞—Å—Å–∏–≤—É 
id —á–µ—Ä–µ–∑ ANY, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N. –ü–æ–∏—Å–∫ –ø–æ title –ø—Ä–∏–≤–µ–ª–∏ –∫ —Ñ–æ—Ä–º–µ, –∫–æ—Ç–æ—Ä–∞—è —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–Ω–¥–µ–∫—Å–æ–º,
–∏–Ω–∞—á–µ –∏–Ω–¥–µ–∫—Å –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è. –ò–∑ –∏–Ω–¥–µ–∫—Å–æ–≤: –æ—Å—Ç–∞–≤–∏–ª–∏/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π btree –Ω–∞ (created_at, id) –ø–æ–¥ keyset –∏
GIN –Ω–∞ tsvector –ø–æ–¥ FTS. –ï—Å–ª–∏ –ø–æ–∏—Å–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—á–µ–Ω—å –≥–æ—Ä—è—á–∏–º, —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî —Ö—Ä–∞–Ω–∏—Ç—å tsvector –∫–∞–∫ STORED/generated 
column –∏ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —É–∂–µ –∫–æ–ª–æ–Ω–∫—É: —ç—Ç–æ —É–±–∏—Ä–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç to_tsvector –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∏ —á–∞—Å—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç CPU. 
#### 4
–ü—É–ª –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Ç–∞–∫: 
* MaxConns=20, 
* MinConns=5, 
* MaxConnLifetime=1h
–û–ø—Ç–∏–º–∞–ª—å–Ω–æ
